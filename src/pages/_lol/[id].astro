---
import BaseLayout, { type BaseLayoutProps } from "@/layouts/BaseLayout.astro";
import allRules from "@/lib/rules";
import Button from "@/components/ui/Button.astro";
import SVG from "@/components/drawable/SVG.astro";
import Canvas from "@/components/drawable/Canvas.astro";
import Form from "@/components/ui/Form.astro";

export function getStaticPaths() {
    return Object.entries(allRules).flatMap(function ([kind, { vis_set, canvas_kind }]) {
        return Object.entries(vis_set).map(function ([id, { name, max_order }]) {
            return {
                params: { kind, id },
                props: {
                    name,
                    max_order,
                    canvas_kind,
                    kind_label: kind
                        .split("-")
                        .filter(function (str) {
                            return 0 !== str.length;
                        })
                        .map(function (str) {
                            return str.slice(0, 1).toLocaleUpperCase() + str.slice(1);
                        })
                        .join(" "),
                },
            };
        });
    });
}

const { kind, id } = Astro.params;
const { name, max_order, kind_label, canvas_kind } = Astro.props;

const pageMetaData = {
    title: `${name} | ${kind_label}`,
    description: "",
    keywords: [],
} satisfies BaseLayoutProps;
---

<BaseLayout {...pageMetaData}>
    <h1 class="text-3xl font-bold underline">{name}</h1>
    <div class="flex flex-col gap-6 lg:flex-row" x-data={`__form_state__(${max_order})`}>
        <div class="flex flex-col gap-3 lg:w-1/3">
            <Form />
            <div class="flex w-full max-w-96 justify-between">
                <Button x-on:click="__reset__();__render__(getState())">Draw</Button>
                <Button x-on:click="resetState();__reset__();">Reset</Button>
                <Button x-on:click={`__save${canvas_kind}AsImage__()`} :disabled="$store.isCanvasEmpty.value">Save</Button>
            </div>
        </div>
        <div class="flex justify-center lg:w-2/3">
            {
                "SVG" === canvas_kind ? (
                    <SVG id="drawing-canvas" />
                ) : "Canvas" === canvas_kind ? (
                    <Canvas id="drawing-canvas" />
                ) : null
            }
        </div>
    </div>
    <div>fractal info</div>
</BaseLayout>
<script is:inline src={`/geo-vis/lib/util/core.js`}></script>
<script is:inline src={`/geo-vis/lib/util/${kind}.js`}></script>
<script is:inline src={`/geo-vis/lib/rules/${kind}/${id}.js`}></script>
<script is:inline src={`/geo-vis/lib/renderer/${kind}.js`}></script>
